name: STG (development) - Build, Infra & Migrations via PR

on:
  pull_request:
    branches: ["main"]                 # alvo do PR
    types: [opened, synchronize, reopened]
    # opcional: remova se quiser disparar sempre
    paths:
      - "services/**"
      - "infra/**"
      - "migrations/**"
      - ".github/workflows/dev-pr-stg-apply.yml"

permissions:
  id-token: write
  contents: read

concurrency:
  group: pr-stg-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  ECR_REGISTRY: ${{ vars.AWS_ACCOUNT_ID }}.dkr.ecr.${{ vars.AWS_REGION }}.amazonaws.com
  ECR_REPOSITORY: ${{ vars.ECR_REPOSITORY }}
  TAG_PREFIX: pr-${{ github.event.pull_request.number }}
  IMAGE_TAG_INTER:  pr-${{ github.event.pull_request.number }}-inter
  IMAGE_TAG_AGENT:  pr-${{ github.event.pull_request.number }}-agent
  IMAGE_TAG_PRINC:  pr-${{ github.event.pull_request.number }}-principal
  NAME_PREFIX: ura-chatbot-ia-pr-${{ github.event.pull_request.number }}
  TF_VAR_region: ${{ vars.AWS_REGION }}
  TF_VAR_name_prefix: ${{ env.NAME_PREFIX }}
  TF_VAR_account_id: ${{ vars.AWS_ACCOUNT_ID }}
  TF_VAR_ecr_repository: ${{ env.ECR_REPOSITORY }}
  TF_VAR_image_tag_api_intermediaria: ${{ env.IMAGE_TAG_INTER }}
  TF_VAR_image_tag_api_agente:        ${{ env.IMAGE_TAG_AGENT }}
  TF_VAR_image_tag_api_principal:     ${{ env.IMAGE_TAG_PRINC }}
  TF_VAR_rds_db_name: app_stg
  TF_VAR_APP_CRM_URL: ${{ vars.APP_CRM_URL }}
  SERVICE_INTER_PATH: services/api-intermediaria
  SERVICE_AGENT_PATH: services/api-agente
  SERVICE_PRINC_PATH: services/api-principal
  INFRA_DIR: infra
  MIGRATIONS_DIR: migrations/sql

jobs:
  build-infra-migrate:
    name: Build images → Terraform apply → Flyway migrate
    runs-on: ubuntu-latest
    environment: development   # garanta que o Environment "development" existe

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME_STG }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & Push - api-intermediaria
        uses: docker/build-push-action@v6
        with:
          context: ${{ env.SERVICE_INTER_PATH }}
          push: true
          tags: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG_INTER }}
          cache-from: type=registry,ref=${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:cache-inter
          cache-to:   type=registry,ref=${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:cache-inter,mode=max

      - name: Build & Push - api-agente
        uses: docker/build-push-action@v6
        with:
          context: ${{ env.SERVICE_AGENT_PATH }}
          push: true
          tags: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG_AGENT }}
          cache-from: type=registry,ref=${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:cache-agent
          cache-to:   type=registry,ref=${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:cache-agent,mode=max

      - name: Build & Push - api-principal
        uses: docker/build-push-action@v6
        with:
          context: ${{ env.SERVICE_PRINC_PATH }}
          push: true
          tags: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG_PRINC }}
          cache-from: type=registry,ref=${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:cache-principal
          cache-to:   type=registry,ref=${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:cache-principal,mode=max

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init (backend S3)
        working-directory: ${{ env.INFRA_DIR }}
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.TF_STATE_BUCKET }}" \
            -backend-config="key=apprunner/pr-${{ github.event.pull_request.number }}/terraform.tfstate" \
            -backend-config="region=${{ vars.AWS_REGION }}"

      - name: Export TF VARs (sensitive)
        run: |
          echo "TF_VAR_OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY_STG }}" >> $GITHUB_ENV
          echo "TF_VAR_APP_CRM_ACESS_TOKEN=${{ secrets.APP_CRM_ACESS_TOKEN_STG }}" >> $GITHUB_ENV
          echo "TF_VAR_API_PRINCIPAL_API_KEY=${{ secrets.API_PRINCIPAL_API_KEY_STG }}" >> $GITHUB_ENV
          echo "TF_VAR_API_PRINCIPAL_SECRET_KEY=${{ secrets.API_PRINCIPAL_SECRET_KEY_STG }}" >> $GITHUB_ENV
          echo "TF_VAR_WHASTAPP_CLIENT_TOKEN=${{ secrets.WHASTAPP_CLIENT_TOKEN_STG }}" >> $GITHUB_ENV
          echo "TF_VAR_WHASTAPP_INSTANCE_ID=${{ secrets.WHASTAPP_INSTANCE_ID_STG }}" >> $GITHUB_ENV
          echo "TF_VAR_WHASTAPP_TOKEN=${{ secrets.WHASTAPP_TOKEN_STG }}" >> $GITHUB_ENV

      - name: Terraform Apply
        working-directory: ${{ env.INFRA_DIR }}
        run: terraform apply -auto-approve

      - name: Install tools (jq)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Read DB creds from Secrets Manager
        run: |
          SECRET_JSON=$(aws secretsmanager get-secret-value \
            --secret-id "/${{ env.NAME_PREFIX }}/db-app-creds" \
            --query SecretString --output text)
          echo "FLYWAY_URL=$(echo "$SECRET_JSON" | jq -r .jdbc_url)" >> $GITHUB_ENV
          echo "FLYWAY_USER=$(echo "$SECRET_JSON" | jq -r .username)" >> $GITHUB_ENV
          echo "FLYWAY_PASSWORD=$(echo "$SECRET_JSON" | jq -r .password)" >> $GITHUB_ENV

      - name: Run Flyway migrate (Docker)
        working-directory: ${{ env.MIGRATIONS_DIR }}/..
        run: |
          docker run --rm \
            -v "$PWD/sql:/flyway/sql" \
            flyway/flyway:latest \
            -url="${FLYWAY_URL}" \
            -user="${FLYWAY_USER}" \
            -password="${FLYWAY_PASSWORD}" \
            -connectRetries=30 \
            migrate
